<%@page import="kr.or.ddit.dcum.vo.MemberVO"%>
<%@page import="kr.or.ddit.dcum.vo.BambooReplyVO"%>
<%@page import="kr.or.ddit.dcum.vo.BambooVO"%>
<%@page import="java.util.List"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" href="http://localhost/test/css/main.css">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- ê²Œì‹œê¸€ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="<%=request.getContextPath()%>/css/cmu_board_view.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
<%
	BambooVO bamVo = (BambooVO)request.getAttribute("bambooVo");
	List<BambooReplyVO> rebamboo = (List<BambooReplyVO>)request.getAttribute("rebambooVo");
	MemberVO loginMember = (MemberVO)session.getAttribute("loginUser");
%>

	$(function(){
		//ê¸€ ëª©ë¡ìœ¼ë¡œ ë˜ëŒì•„ê°€ê¸°
		$('#bambooList').on('click', function(){
			location.href="<%= request.getContextPath() %>/bamboo.do";
		})
		
// 		var gubun = "";
		//ê¸€ ì‚­ì œ ëª¨ë‹¬ì°½ ë„ìš°ê¸°
		$('#deleteBamboo').on('click', function(){
			$('#deleteModal').modal('show');
			
			bonum = $(this).parents().find('.sec_num').val();
			
			//ëª¨ë‹¬ì°½ì— ê²Œì‹œê¸€ ë²ˆí˜¸ë¥¼ ì…‹íŒ…
			$('.delhid').val(bonum);
		})
		
		//ëª¨ë‹¬ì°½ì—ì„œ ì‚­ì œë²„íŠ¼
		$('#del').on('click', function(){
			form = $('#bambooForm').get(0);
			form.action = "<%= request.getContextPath() %>/deleteBamboo.do";
			form.submit();
		})
		
		//ëŒ“ê¸€, ê¸€ì‚­ì œ
<%-- 		
		$('#del').on('click', function(){
			var form = null;
			if(gubun=="Bamboo"){
				form = $('#bambooForm').get(0);
				form.action = "<%= request.getContextPath() %>/deleteBamboo.do";
				
			}else if(gubun=="ReBamboo"){
				form = $('#rebambooForm');
				form.action = "<%= request.getContextPath() %>/deleteReBamboo.do"; 
			}
			gubun="";
			
			if(form!=null){
				form.submit();
			} 
			 
			$('#deleteModal').modal('hide');
			
		}) --%>
		
		//ê¸€ ìˆ˜ì •
		$('#updateBamboo').on('click', function(){
			var form = $('#bambooForm').get(0);
			form.action = "<%= request.getContextPath() %>/updateBambooForm.do";
			form.submit();
		})
		
		//-------------------------------------------------------------------------
		
		//ëŒ“ê¸€ ì…ë ¥ì‹œ ì¤„ë°”ê¿ˆ
		$('#insertReply').on('click', function(){
			var str = $('#reply').val();
			str = str.replace(/(?:\r\n|\r|\n)/g, '<br/>');
			$('#reply').val(str);
			
// 			$('#reply').val().replace(/\n/g, "<br>");
			
			//ëŒ“ê¸€ ì•„ì´ë”” ìˆ«ì +1ì”©
// 			name = $('#rewriter').val();
			
		})
		
		//ëŒ“ê¸€ ì‚­ì œ ëª¨ë‹¬ì°½ ë„ìš°ê¸°
		$('.deleteReBamboo').on('click', function(){
			$("#redeleteModal").modal('show');
			
			renum = $(this).parent().find('.renum').val();
			
			//ëª¨ë‹¬ì°½ì— ëŒ“ê¸€ ë²ˆí˜¸ë¥¼ ì…‹íŒ…
			$('.redelhid').val(renum);
		})
		
		//ëª¨ë‹¬ì—ì„œ ëŒ“ê¸€ ì‚­ì œ
		$('#redel').on('click', function(){
			var form = this.form;
			//alert("test=>" + $(form).attr("id"));
			form.action = "<%= request.getContextPath() %>/deleteReBamboo.do"; 
			form.submit();
		})
		
		//ëŒ“ê¸€ ìˆ˜ì •
		$('.updateReBamboo').on('click', function(){
			if($(this).val() == "ìˆ˜ì •"){
				cont = $(this).parents('tbody').find('.contre').html();
				cont = cont.replace(/<br>/g, "\n");
				
				cont1 = '<textarea rows="4" cols="147" placeholder="ë‚´ìš© ì…ë ¥" class="reply" name="sec_re_cont">'+ cont + '</textarea>';
			    $(this).parents('tbody').find('.contre').html(cont1);
			    
			    $(this).attr("value", "ì™„ë£Œ");
			    
			    $('.deleteReBamboo').hide();
			    $('.cancel').show();
			    
			    //ì·¨ì†Œ ë²„íŠ¼
			    $('.cancel').on('click', function(){
			    	location.href="<%= request.getContextPath() %>/bambooView.do?sec_num=<%= bamVo.getSec_num() %>";
			    })
			
			//ìˆ˜ì • ë²„íŠ¼
			}else if($(this).val() == "ì™„ë£Œ"){
				str1 = $(this).parents('tbody').find('.reply').val();
				str1 = str1.replace(/\n/g, '<br/>');
				$(this).parents('tbody').find('.reply').val(str1);
				
				var form = $('#rebambooForm').get(0);
				form.action = "<%= request.getContextPath() %>/updateReBamboo.do";
				form.submit();
		    }
			
		})
		
		//ìƒˆë¡œ ê³ ì¹¨
// 		$('#reReply').on('click', function(){
// 			 $("#reList").load(location.href + "#reList");
// 		})
		
	})
		

</script>

</head>
<body>


	<div class="container">
	<h2>ëŒ€ë‚˜ë¬´ìˆ²</h2>
	
	<!-- ê²Œì‹œê¸€ ì°½ -->
	<form id="bambooForm">
		<input type="hidden" class="sec_num" name="sec_num" value="<%= bamVo.getSec_num() %>">
		<input type="hidden" class="mem_id" name="mem_id" value="<%= loginMember.getMem_id() %>">
	</form>
	            
		<table class="table">
			<thead>
				<tr class="table-success">
					<th colspan="3" id="title"><%= bamVo.getSec_title() %></th>
				</tr>
			</thead>

			<tbody>
				<tr>
					<td id="writer">ì‚¬ëŒğŸ™‹â€â™‚ï¸</td>
					<td></td>
					<td id="date"><%= bamVo.getSec_date() %></td>
				</tr>
			
		  		<tr>
					<td id="cont" colspan="3"><%= bamVo.getSec_cont() %></td>
				</tr>
				
				<tr>
					<td colspan="3">
				  	<% if(loginMember != null && loginMember.getMem_id().equals(bamVo.getMem_id()) || loginMember.getMem_sort_nm().equals("êµìˆ˜")) { %>
				  		
				  		<input type="button" value="ìˆ˜ì •" id="updateBamboo" class="btn btn-dark">
				  		<input type="button" value="ì‚­ì œ" id="deleteBamboo" class="btn btn-dark">
				  	<% } %>
					</td>
				</tr>
			</tbody>
  		</table>
  		
  	</div>
  		
  		
	<!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
	<div class="container" id="reList">
	<form id="rebambooForm">
	<table class="table">
		<thead>
			<tr class="table-success">
				<th colspan="4">ëŒ“ê¸€</th>
			</tr>
		</thead>
		<%
			for(BambooReplyVO revo : rebamboo){
		%>
		<tbody>
	  		<tr>
				<td id="rewr">ğŸ‹<%= revo.getSec_re_writer() %>ğŸ‹</td>
				<td></td>
				<td></td>
				<td id="redate"><%= revo.getSec_re_date() %></td>
				
			</tr>
			
			<tr>
				<td colspan="3" class="contre"><%= revo.getSec_re_cont() %></td>
				<td class="rebut">
				
				<% if(loginMember != null && loginMember.getMem_id().equals(revo.getMem_id()) || loginMember.getMem_sort_nm().equals("êµìˆ˜")) { %>
					<!-- ë¡œê·¸ì¸í•œ ì‚¬ëŒì´ë‘ ì¼ì¹˜í• ë•Œë§Œ ëœ¨ë„ë¡ ìˆ˜ì • -->
					<input type="hidden" value="<%= bamVo.getSec_num() %>" name="sec_num">
					<input type="hidden" value="<%= revo.getSec_re_num() %>" name="sec_re_num" class="renum">
					<input type="hidden" value="<%= revo.getSec_re_writer() %>" name="sec_re_writer">
					
					<input type="button" value="ìˆ˜ì •" class="updateReBamboo btn btn-dark">
					<input type="button" value="ì‚­ì œ" class="deleteReBamboo btn btn-dark">
					<input type="button" value="ì·¨ì†Œ" class="cancel" style="display: none;"  class="btn btn-secondary">
				<% } %>
				</td>
			</tr>
		</tbody>
		<% 
		}
		%>
			
 		</table>
		</form>
 		
 		
 		<!-- ëŒ“ê¸€ ì…ë ¥ì°½ -->
 		<form action="<%=request.getContextPath()%>/insertReBamboo.do" mothod="post">
<!--  			<input type="button" value="ìƒˆë¡œ ê³ ì¹¨" id="reReply"> -->
 			<br><br>
	  		<textarea rows="4" cols="147" placeholder="ë‚´ìš© ì…ë ¥" id="reply" name="sec_re_cont"></textarea>
			<input type="hidden" id="rewriter" name="sec_re_writer" value="ëŒ€ë‚˜ë¬´">
			<input type="hidden" name="sec_num" value="<%= bamVo.getSec_num() %>">
			<input type="hidden" name="mem_id" value="<%= loginMember.getMem_id() %>">
			<br>
			<input type="submit" value="ì…ë ¥" id="insertReply" class="btn btn-secondary">
		</form>
		<br><br>
		
		<!-- ëª©ë¡ -->
		<button type="button" id="bambooList"class="btn">
			<img src="<%=request.getContextPath()%>/images/icon/ëª©ë¡ì•„ì´ì½˜.PNG">
		</button>
	</div>
	
	
	<!-- ê²Œì‹œê¸€ ì‚­ì œì°½ -->
	<div class="modal fade" id="deleteModal">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
	
				<!-- Modal Header -->
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				
				<!-- Modal body -->
				<div class="modal-body">
					<form id="wrform">
						<label>ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</label>
						<input type="hidden" name="del" class="delhid">
					</form>
				</div>
				
				<!-- Modal footer -->
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" id="del">ì‚­ì œ</button>
					<button type="button" class="btn btn-danger" data-dismiss="modal">ì·¨ì†Œ</button>
				</div>
				
			</div>
		</div>
	</div>
	
	<!-- ëŒ“ê¸€ ì‚­ì œì°½ -->
	<div class="modal fade" id="redeleteModal">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
	
				<form id="wrform">
					<!-- Modal Header -->
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
					</div>
					
					<!-- Modal body -->
					<div class="modal-body">
							<label>ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</label>
							<input type="hidden" name="sec_num" value="<%=bamVo.getSec_num() %>" >
							<input type="hidden" name="sec_re_num" class="redelhid">
					</div>
					
					<!-- Modal footer -->
					<div class="modal-footer">
						<button type="button" class="btn btn-danger" id="redel">ì‚­ì œ</button>
						<button type="button" class="btn btn-danger" data-dismiss="modal">ì·¨ì†Œ</button>
					</div>
				</form>
				
			</div>
		</div>
	</div>

</body>
</html>